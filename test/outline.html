<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
</head>

<body>
  <script src="../phina.js/build/phina.js"></script>
  <script>
  phina.main(function() {

    phina.asset.AssetLoader()
      .on("load", function() {
        main();
      })
      .load({
        image: {
          player: "../bundle/asset/player.png",
          bullets: "../bundle/asset/bullets.png",
          bomb: "../bundle/asset/bomb.png",
        }
      });
  });

  var outline = function(textureName, color) {
    var texture = phina.asset.AssetManager.get("image", textureName);
    if (texture == null) {
      return;
    }
    var w = texture.domElement.width;
    var h = texture.domElement.height;

    var src = phina.graphics.Canvas().setSize(w, h);
    src.context.drawImage(texture.domElement, 0, 0);

    var srcData = src.context.getImageData(0, 0, w, h);
    var data = srcData.data;

    var dst = phina.graphics.Canvas().setSize(w, h);
    dst.fillStyle = color || "white";
    for (var y = 0; y < h; y++) {
      for (var x = 0; x < w; x++) {

        var cIndex = ((y + 0) * w + (x + 0)) * 4 + 3;

        var lIndex = ((y + 0) * w + (x - 1)) * 4 + 3;
        var rIndex = ((y + 0) * w + (x + 1)) * 4 + 3;
        var tIndex = ((y - 1) * w + (x + 0)) * 4 + 3;
        var bIndex = ((y + 1) * w + (x + 0)) * 4 + 3;
        var l = (0 <= lIndex && lIndex < data.length) ? data[lIndex] : 255;
        var r = (0 <= rIndex && rIndex < data.length) ? data[rIndex] : 255;
        var t = (0 <= tIndex && tIndex < data.length) ? data[tIndex] : 255;
        var b = (0 <= bIndex && bIndex < data.length) ? data[bIndex] : 255;

        var a = data[cIndex];

        if (a > 0 && (l == 0 || r == 0 || t == 0 || b == 0)) {
          var g = dst.context.createRadialGradient(x, y, 0, x, y, 2);
          g.addColorStop(0.0, "rgba(255, 255, 255, 0.6)");
          g.addColorStop(1.0, "rgba(255, 255, 255, 0.0)");
          dst.fillStyle = g;
          dst.fillCircle(x, y, 2);
        }
      }
    }

    phina.asset.AssetManager.set("image", textureName + "Outline", dst);
  };

  var main = function() {
    document.body.style.backgroundColor = "black";
    outline("bullets", "red");
    outline("player");
    outline("bomb", "lightgreen");

    document.body.appendChild(phina.asset.AssetManager.get("image", "bulletsOutline").domElement);
    document.body.appendChild(phina.asset.AssetManager.get("image", "playerOutline").domElement);
    document.body.appendChild(phina.asset.AssetManager.get("image", "bombOutline").domElement);
  };
  </script>
</body>

</html>